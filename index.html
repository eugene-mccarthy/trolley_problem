<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moral Weights Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Fraunces:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-primary: #58a6ff;
            --accent-secondary: #3fb950;
            --accent-warm: #d29922;
            --border-default: #30363d;
            --border-muted: #21262d;
            --selection-a: #2d4a3e;
            --selection-a-border: #3fb950;
            --selection-b: #2d3a4a;
            --selection-b-border: #58a6ff;
            --negative: #f85149;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-default);
        }

        h1 {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Screen styles */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .warning-box {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--negative);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .warning-box p {
            color: var(--negative);
            margin: 0;
            font-size: 0.9rem;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-primary);
        }

        .checkbox-group span {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            font-weight: 500;
            font-family: inherit;
        }

        .btn:hover:not(:disabled) {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: #79b8ff;
            border-color: #79b8ff;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-full {
            width: 100%;
        }

        /* Progress bar */
        .progress-container {
            margin-bottom: 1.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
            transition: width 0.3s ease;
        }

        /* Timer */
        .timer-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--text-secondary);
            min-width: 40px;
        }

        .timer.warning {
            color: var(--accent-warm);
        }

        .timer.critical {
            color: var(--negative);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Scenario display */
        .scenario-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .scenario-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .scenario-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent-warm);
            background: rgba(210, 153, 34, 0.1);
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
        }

        .scenario-question {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.3rem;
            line-height: 1.5;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .choice-btn {
            padding: 1.25rem 1.5rem;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-default);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
        }

        .choice-btn:hover:not(:disabled) {
            border-color: var(--text-muted);
            transform: translateX(4px);
        }

        .choice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .choice-btn.selected-a {
            background: var(--selection-a);
            border-color: var(--selection-a-border);
        }

        .choice-btn.selected-b {
            background: var(--selection-b);
            border-color: var(--selection-b-border);
        }

        .choice-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: block;
        }

        .choice-text {
            font-weight: 500;
            line-height: 1.4;
        }

        .choice-consequences {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-muted);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .consequence {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .consequence-icon {
            font-size: 0.9rem;
        }

        .skip-btn {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .skip-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-secondary);
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* Results styling */
        .results-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .results-section h3 {
            font-family: 'Fraunces', Georgia, serif;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .weight-grid {
            display: grid;
            gap: 0.75rem;
        }

        .weight-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .weight-label {
            min-width: 140px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .weight-bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .weight-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .weight-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--bg-primary);
        }

        .weight-value-outside {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .insight-box {
            background: rgba(88, 166, 255, 0.05);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .insight-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .insight-box p:last-child {
            margin-bottom: 0;
        }

        .caveat-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .caveat-box p {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .heatmap {
            display: grid;
            gap: 2px;
            min-width: 400px;
        }

        .heatmap-cell {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .heatmap-header {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .heatmap-value {
            color: var(--text-primary);
        }

        /* Tutorial */
        .tutorial-step {
            text-align: center;
            padding: 2rem 0;
        }

        .tutorial-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .tutorial-text {
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto 1.5rem;
        }

        /* Block indicator */
        .block-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .block-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
        }

        .block-dot.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .block-dot.complete {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
            }

            .card {
                padding: 1.5rem;
            }

            .scenario-question {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Moral Weights Explorer</h1>
            <p class="subtitle">Explore your moral intuitions through hypothetical dilemmas</p>
        </header>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <div class="card">
                <h2>Welcome</h2>
                <p>This tool will present you with a series of hypothetical moral dilemmas about human and animal lives. There are no right or wrong answers ‚Äî the goal is to explore what your choices reveal about your moral intuitions.</p>
                <p>You'll answer approximately 30-40 questions across several categories, including trade-offs between lives, medical research scenarios, and quality-of-life decisions.</p>
                
                <div class="warning-box">
                    <p><strong>Content Warning:</strong> This survey contains hypothetical scenarios involving death, disability, and animal harm. All scenarios are fictional thought experiments.</p>
                </div>

                <label class="checkbox-group">
                    <input type="checkbox" id="consentCheck">
                    <span>I understand these are hypothetical scenarios and I'm comfortable continuing.</span>
                </label>

                <div class="btn-group">
                    <button class="btn btn-primary btn-full" id="startBtn" disabled>Continue</button>
                </div>
            </div>
        </div>

        <!-- Demographics Screen -->
        <div id="demographicsScreen" class="screen">
            <div class="card">
                <h2>About You (Optional)</h2>
                <p>This information helps contextualise responses. All fields are optional.</p>

                <div class="form-group">
                    <label for="ageGroup">Age Group</label>
                    <select id="ageGroup">
                        <option value="">Prefer not to say</option>
                        <option value="18-24">18-24</option>
                        <option value="25-34">25-34</option>
                        <option value="35-44">35-44</option>
                        <option value="45-54">45-54</option>
                        <option value="55-64">55-64</option>
                        <option value="65+">65+</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="country">Country</label>
                    <select id="country">
                        <option value="">Prefer not to say</option>
                        <option value="UK">United Kingdom</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="diet">Dietary Choice</label>
                    <select id="diet">
                        <option value="">Prefer not to say</option>
                        <option value="meat">Meat eater</option>
                        <option value="pescatarian">Pescatarian</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="vegan">Vegan</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="scienceInvolvement">Involvement in Science/Medicine</label>
                    <select id="scienceInvolvement">
                        <option value="">Prefer not to say</option>
                        <option value="none">No involvement</option>
                        <option value="student">Student in related field</option>
                        <option value="professional">Professional in related field</option>
                        <option value="researcher">Researcher</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn" id="skipDemoBtn">Skip</button>
                    <button class="btn btn-primary" id="continueDemoBtn">Continue</button>
                </div>
            </div>
        </div>

        <!-- Tutorial Screen -->
        <div id="tutorialScreen" class="screen">
            <div class="card">
                <h2>Quick Tutorial</h2>
                
                <div class="tutorial-step">
                    <div class="tutorial-icon">‚öñÔ∏è</div>
                    <p class="tutorial-text">Each question presents two options. Click the option you would choose. There's an 8-second timer ‚Äî if it runs out, a "Next" button will appear, but try to answer if you can.</p>
                </div>

                <div class="tutorial-step">
                    <div class="tutorial-icon">üîÑ</div>
                    <p class="tutorial-text">You can go back to previous questions using the "Back" button. Your answers are saved automatically.</p>
                </div>

                <div class="tutorial-step">
                    <div class="tutorial-icon">üìä</div>
                    <p class="tutorial-text">At the end, you'll see a summary of what your answers suggest about your moral intuitions ‚Äî not a judgment, just a reflection.</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary btn-full" id="startQuestionsBtn">Begin Questions</button>
                </div>
            </div>
        </div>

        <!-- Main Questions Screen -->
        <div id="questionsScreen" class="screen">
            <div class="progress-container">
                <div class="progress-header">
                    <span class="progress-text" id="progressText">Question 1 of 35</span>
                    <div class="timer-container">
                        <span class="timer" id="timer">8</span>
                        <span class="progress-text">seconds</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="block-indicator" id="blockIndicator"></div>

            <div class="scenario-card" id="scenarioCard">
                <div class="scenario-meta">
                    <span class="scenario-type" id="scenarioType">Direct Trade-off</span>
                </div>
                <p class="scenario-question" id="scenarioQuestion">Loading question...</p>
                
                <div class="choices" id="choicesContainer">
                    <button class="choice-btn" data-choice="A" id="choiceA">
                        <span class="choice-label">Option A</span>
                        <span class="choice-text" id="choiceAText">Loading...</span>
                        <div class="choice-consequences" id="choiceAConsequences"></div>
                    </button>
                    <button class="choice-btn" data-choice="B" id="choiceB">
                        <span class="choice-label">Option B</span>
                        <span class="choice-text" id="choiceBText">Loading...</span>
                        <div class="choice-consequences" id="choiceBConsequences"></div>
                    </button>
                </div>

                <button class="skip-btn" id="skipQuestionBtn" style="display: none;">Skip this question</button>
            </div>

            <div class="nav-buttons">
                <button class="btn" id="backBtn" disabled>‚Üê Back</button>
                <button class="btn btn-primary" id="nextBtn" style="display: none;">Next ‚Üí</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <h2>Your Results</h2>
                <p>Based on your answers, here's what your choices suggest about your moral intuitions. Remember: these are approximations from simplified scenarios, not definitive labels.</p>
            </div>

            <div class="results-section">
                <h3>Human vs Animal Life Equivalences</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">How many animal lives your choices treated as equivalent to one average adult human life:</p>
                <div class="weight-grid" id="animalEquivalences"></div>
                <div class="insight-box" id="animalInsight"></div>
            </div>

            <div class="results-section">
                <h3>Human Profile Weights</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">Relative value placed on different human profiles (adult = 1.0):</p>
                <div class="weight-grid" id="humanWeights"></div>
            </div>

            <div class="results-section">
                <h3>Risk Tolerance for Animal Testing</h3>
                <div class="insight-box" id="riskInsight"></div>
            </div>

            <div class="results-section">
                <h3>Quality of Life vs Death Trade-offs</h3>
                <div class="insight-box" id="qolInsight"></div>
            </div>

            <div class="caveat-box">
                <p>These numbers are approximations derived from your choices in simplified scenarios. Real-world decisions involve many more factors. This tool is meant to prompt reflection, not to define your ethics.</p>
            </div>

            <div class="btn-group">
                <button class="btn" id="exportResultsBtn">Export Data</button>
                <button class="btn btn-primary" id="restartBtn">Start Over</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ENTITY DEFINITIONS
        // ============================================
        const humanProfiles = {
            adult_standard: {
                id: 'adult_standard',
                label: 'Adult (healthy)',
                description: 'A healthy 30-year-old adult',
                baseline_qol: 0.9,
                remaining_life_expectancy: 50
            },
            adult_disabled: {
                id: 'adult_disabled',
                label: 'Adult (disabled)',
                description: 'An adult with severe disability, potential for major improvement',
                baseline_qol: 0.4,
                remaining_life_expectancy: 40
            },
            child: {
                id: 'child',
                label: 'Child',
                description: 'An 8-year-old child',
                baseline_qol: 0.9,
                remaining_life_expectancy: 70
            },
            elderly: {
                id: 'elderly',
                label: 'Elderly person',
                description: 'An 80-year-old with some health conditions',
                baseline_qol: 0.6,
                remaining_life_expectancy: 8
            },
            pregnant: {
                id: 'pregnant',
                label: 'Pregnant woman',
                description: 'A pregnant woman (includes the foetus)',
                baseline_qol: 0.85,
                remaining_life_expectancy: 50
            }
        };

        const animalProfiles = {
            mouse: {
                id: 'mouse',
                label: 'Mouse',
                labelPlural: 'Mice',
                description: 'A lab mouse',
                baseline_qol: 0.5
            },
            dog: {
                id: 'dog',
                label: 'Dog',
                labelPlural: 'Dogs',
                description: 'A domestic dog',
                baseline_qol: 0.7
            },
            pig: {
                id: 'pig',
                label: 'Pig',
                labelPlural: 'Pigs',
                description: 'A domestic pig',
                baseline_qol: 0.6
            },
            monkey: {
                id: 'monkey',
                label: 'Monkey',
                labelPlural: 'Monkeys',
                description: 'A macaque monkey',
                baseline_qol: 0.7
            },
            chicken: {
                id: 'chicken',
                label: 'Chicken',
                labelPlural: 'Chickens',
                description: 'A chicken',
                baseline_qol: 0.4
            }
        };

        // ============================================
        // SCENARIO GENERATION
        // ============================================
        
        function generateScenarios() {
            const scenarios = [];
            let idCounter = 0;

            // BLOCK 1: Human vs Human baselines (5 questions)
            const humanBaselines = [
                { a: { profile: 'adult_standard', count: 1 }, b: { profile: 'adult_standard', count: 2 } },
                { a: { profile: 'child', count: 1 }, b: { profile: 'adult_standard', count: 1 } },
                { a: { profile: 'child', count: 1 }, b: { profile: 'elderly', count: 2 } },
                { a: { profile: 'pregnant', count: 1 }, b: { profile: 'adult_standard', count: 1 } },
                { a: { profile: 'adult_standard', count: 1 }, b: { profile: 'elderly', count: 1 } }
            ];

            humanBaselines.forEach(config => {
                scenarios.push({
                    id: `scenario_${++idCounter}`,
                    block: 1,
                    type: 'human_baseline',
                    typeLabel: 'Human Comparison',
                    prompt: 'You can only save one group. Which do you choose to save?',
                    options: [
                        {
                            id: 'A',
                            label: `Save ${config.a.count} ${config.a.count > 1 ? humanProfiles[config.a.profile].label + 's' : humanProfiles[config.a.profile].label}`,
                            consequences: [
                                { entity_type: 'human', profile_id: config.a.profile, count: config.a.count, outcome: 'survive' },
                                { entity_type: 'human', profile_id: config.b.profile, count: config.b.count, outcome: 'die' }
                            ]
                        },
                        {
                            id: 'B',
                            label: `Save ${config.b.count} ${config.b.count > 1 ? humanProfiles[config.b.profile].label + 's' : humanProfiles[config.b.profile].label}`,
                            consequences: [
                                { entity_type: 'human', profile_id: config.a.profile, count: config.a.count, outcome: 'die' },
                                { entity_type: 'human', profile_id: config.b.profile, count: config.b.count, outcome: 'survive' }
                            ]
                        }
                    ]
                });
            });

            // BLOCK 2: Human vs Animal (certain outcomes) - 12 questions
            const animalCounts = [1, 10, 100, 1000];
            const animals = ['mouse', 'dog', 'pig', 'monkey'];
            
            animals.forEach(animal => {
                animalCounts.forEach(count => {
                    if (Math.random() < 0.5) { // Sample to keep reasonable length
                        const animalLabel = count === 1 ? animalProfiles[animal].label : animalProfiles[animal].labelPlural;
                        scenarios.push({
                            id: `scenario_${++idCounter}`,
                            block: 2,
                            type: 'human_animal_certain',
                            typeLabel: 'Life Trade-off',
                            prompt: `Would you choose to save 1 adult human or ${count.toLocaleString()} ${animalLabel.toLowerCase()}?`,
                            options: [
                                {
                                    id: 'A',
                                    label: 'Save the human',
                                    consequences: [
                                        { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'survive' },
                                        { entity_type: 'animal', profile_id: animal, count: count, outcome: 'die' }
                                    ]
                                },
                                {
                                    id: 'B',
                                    label: `Save the ${animalLabel.toLowerCase()}`,
                                    consequences: [
                                        { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'die' },
                                        { entity_type: 'animal', profile_id: animal, count: count, outcome: 'survive' }
                                    ]
                                }
                            ],
                            metadata: { animal, animalCount: count }
                        });
                    }
                });
            });

            // Ensure we have good coverage
            // Add specific threshold-finding questions
            [10, 100, 1000, 10000].forEach(count => {
                scenarios.push({
                    id: `scenario_${++idCounter}`,
                    block: 2,
                    type: 'human_animal_certain',
                    typeLabel: 'Life Trade-off',
                    prompt: `Would you kill ${count.toLocaleString()} mice to save 1 adult human from certain death?`,
                    options: [
                        {
                            id: 'A',
                            label: 'Yes, save the human',
                            consequences: [
                                { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'survive' },
                                { entity_type: 'animal', profile_id: 'mouse', count: count, outcome: 'die' }
                            ]
                        },
                        {
                            id: 'B',
                            label: 'No, do not kill the mice',
                            consequences: [
                                { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'die' },
                                { entity_type: 'animal', profile_id: 'mouse', count: count, outcome: 'survive' }
                            ]
                        }
                    ],
                    metadata: { animal: 'mouse', animalCount: count }
                });
            });

            // BLOCK 3: Probabilistic medical benefit - 10 questions
            const probabilities = [0.05, 0.15, 0.30, 0.60, 0.90];
            const testAnimalCounts = [100, 1000, 5000];
            const humansBenefited = [10, 100, 1000];

            probabilities.forEach(prob => {
                const animalCount = testAnimalCounts[Math.floor(Math.random() * testAnimalCounts.length)];
                const humanCount = humansBenefited[Math.floor(Math.random() * humansBenefited.length)];
                const animal = animals[Math.floor(Math.random() * animals.length)];
                const animalLabel = animalProfiles[animal].labelPlural.toLowerCase();
                
                scenarios.push({
                    id: `scenario_${++idCounter}`,
                    block: 3,
                    type: 'testing_probabilistic',
                    typeLabel: 'Medical Research',
                    prompt: `A proposed experiment will kill ${animalCount.toLocaleString()} ${animalLabel}. There is a ${Math.round(prob * 100)}% chance it leads to a treatment that saves ${humanCount.toLocaleString()} humans per year from a fatal disease. Would you approve this experiment?`,
                    options: [
                        {
                            id: 'A',
                            label: 'Yes, approve the experiment',
                            consequences: [
                                { entity_type: 'animal', profile_id: animal, count: animalCount, outcome: 'die', certain: true },
                                { entity_type: 'human', profile_id: 'adult_standard', count: humanCount, outcome: 'survive', probability: prob }
                            ]
                        },
                        {
                            id: 'B',
                            label: 'No, do not approve',
                            consequences: [
                                { entity_type: 'animal', profile_id: animal, count: animalCount, outcome: 'survive' },
                                { entity_type: 'human', profile_id: 'adult_standard', count: humanCount, outcome: 'at_risk' }
                            ]
                        }
                    ],
                    metadata: { probability: prob, animalCount, humanCount, animal }
                });
            });

            // BLOCK 4: Quality of life improvements - 5 questions
            const qolImprovements = [
                { from: 0.3, to: 0.7, description: 'severe chronic pain to manageable discomfort' },
                { from: 0.4, to: 0.9, description: 'severe disability to near-full independence' },
                { from: 0.5, to: 0.8, description: 'moderate disability to good function' }
            ];

            qolImprovements.forEach(qol => {
                const animalCount = [100, 500, 1000][Math.floor(Math.random() * 3)];
                const prob = [0.3, 0.5, 0.7][Math.floor(Math.random() * 3)];
                
                scenarios.push({
                    id: `scenario_${++idCounter}`,
                    block: 4,
                    type: 'qol_improvement',
                    typeLabel: 'Quality of Life',
                    prompt: `A 35-year-old adult lives with ${qol.description.split(' to ')[0]} (quality of life ${qol.from}/1.0). A treatment could improve their quality of life to ${qol.to}/1.0, but requires experiments that kill ${animalCount.toLocaleString()} mice with a ${Math.round(prob * 100)}% chance of success. Do you approve?`,
                    options: [
                        {
                            id: 'A',
                            label: 'Yes, approve the research',
                            consequences: [
                                { entity_type: 'animal', profile_id: 'mouse', count: animalCount, outcome: 'die' },
                                { entity_type: 'human', profile_id: 'adult_disabled', count: 1, outcome: 'improve_qol', qol_change: qol.to - qol.from, probability: prob }
                            ]
                        },
                        {
                            id: 'B',
                            label: 'No, do not approve',
                            consequences: [
                                { entity_type: 'animal', profile_id: 'mouse', count: animalCount, outcome: 'survive' },
                                { entity_type: 'human', profile_id: 'adult_disabled', count: 1, outcome: 'no_change' }
                            ]
                        }
                    ],
                    metadata: { qolFrom: qol.from, qolTo: qol.to, probability: prob, animalCount }
                });
            });

            // BLOCK 5: Transplant scenarios - 4 questions
            const transplantScenarios = [
                { human: 'child', animal: 'pig', count: 3 },
                { human: 'adult_standard', animal: 'pig', count: 2 },
                { human: 'child', animal: 'monkey', count: 1 },
                { human: 'elderly', animal: 'pig', count: 3 }
            ];

            transplantScenarios.forEach(config => {
                const humanLabel = humanProfiles[config.human].label.toLowerCase();
                const animalLabel = config.count === 1 ? animalProfiles[config.animal].label.toLowerCase() : animalProfiles[config.animal].labelPlural.toLowerCase();
                
                scenarios.push({
                    id: `scenario_${++idCounter}`,
                    block: 5,
                    type: 'transplant',
                    typeLabel: 'Organ Transplant',
                    prompt: `A ${humanLabel} will die without a heart transplant. It is possible to grow a compatible organ using ${config.count} ${animalLabel}, but they would all be killed in the process. Is this acceptable?`,
                    options: [
                        {
                            id: 'A',
                            label: 'Yes, proceed with the transplant',
                            consequences: [
                                { entity_type: 'human', profile_id: config.human, count: 1, outcome: 'survive' },
                                { entity_type: 'animal', profile_id: config.animal, count: config.count, outcome: 'die' }
                            ]
                        },
                        {
                            id: 'B',
                            label: 'No, do not proceed',
                            consequences: [
                                { entity_type: 'human', profile_id: config.human, count: 1, outcome: 'die' },
                                { entity_type: 'animal', profile_id: config.animal, count: config.count, outcome: 'survive' }
                            ]
                        }
                    ],
                    metadata: { humanProfile: config.human, animal: config.animal, animalCount: config.count }
                });
            });

            // BLOCK 6: Special categories & attention checks - 4 questions
            // Attention check: obviously dominated choice
            scenarios.push({
                id: `scenario_${++idCounter}`,
                block: 6,
                type: 'attention_check',
                typeLabel: 'Trade-off',
                prompt: 'You can save either group. Which do you choose?',
                options: [
                    {
                        id: 'A',
                        label: 'Save 1 adult',
                        consequences: [
                            { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'survive' }
                        ]
                    },
                    {
                        id: 'B',
                        label: 'Save 1 adult AND 10 mice',
                        consequences: [
                            { entity_type: 'human', profile_id: 'adult_standard', count: 1, outcome: 'survive' },
                            { entity_type: 'animal', profile_id: 'mouse', count: 10, outcome: 'survive' }
                        ]
                    }
                ],
                isAttentionCheck: true,
                correctAnswer: 'B'
            });

            // Animal vs animal
            scenarios.push({
                id: `scenario_${++idCounter}`,
                block: 6,
                type: 'animal_comparison',
                typeLabel: 'Animal Comparison',
                prompt: 'You can only save one group. Which do you save?',
                options: [
                    {
                        id: 'A',
                        label: 'Save 1 dog',
                        consequences: [
                            { entity_type: 'animal', profile_id: 'dog', count: 1, outcome: 'survive' },
                            { entity_type: 'animal', profile_id: 'mouse', count: 100, outcome: 'die' }
                        ]
                    },
                    {
                        id: 'B',
                        label: 'Save 100 mice',
                        consequences: [
                            { entity_type: 'animal', profile_id: 'dog', count: 1, outcome: 'die' },
                            { entity_type: 'animal', profile_id: 'mouse', count: 100, outcome: 'survive' }
                        ]
                    }
                ]
            });

            scenarios.push({
                id: `scenario_${++idCounter}`,
                block: 6,
                type: 'animal_comparison',
                typeLabel: 'Animal Comparison',
                prompt: 'You can only save one group. Which do you save?',
                options: [
                    {
                        id: 'A',
                        label: 'Save 1 monkey',
                        consequences: [
                            { entity_type: 'animal', profile_id: 'monkey', count: 1, outcome: 'survive' },
                            { entity_type: 'animal', profile_id: 'chicken', count: 50, outcome: 'die' }
                        ]
                    },
                    {
                        id: 'B',
                        label: 'Save 50 chickens',
                        consequences: [
                            { entity_type: 'animal', profile_id: 'monkey', count: 1, outcome: 'die' },
                            { entity_type: 'animal', profile_id: 'chicken', count: 50, outcome: 'survive' }
                        ]
                    }
                ]
            });

            // Shuffle within blocks, then concatenate
            const blocks = [1, 2, 3, 4, 5, 6];
            let orderedScenarios = [];
            
            blocks.forEach(blockNum => {
                const blockScenarios = scenarios.filter(s => s.block === blockNum);
                // Shuffle
                for (let i = blockScenarios.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [blockScenarios[i], blockScenarios[j]] = [blockScenarios[j], blockScenarios[i]];
                }
                // Randomize option order
                blockScenarios.forEach(s => {
                    if (Math.random() < 0.5 && !s.isAttentionCheck) {
                        [s.options[0], s.options[1]] = [s.options[1], s.options[0]];
                        s.options[0].id = 'A';
                        s.options[1].id = 'B';
                    }
                });
                orderedScenarios = orderedScenarios.concat(blockScenarios);
            });

            return orderedScenarios;
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let state = {
            sessionId: generateSessionId(),
            sessionStart: new Date().toISOString(),
            demographics: {},
            scenarios: [],
            currentIndex: 0,
            responses: [],
            timerInterval: null,
            timeRemaining: 8
        };

        function generateSessionId() {
            return 'sess_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function updateProgress() {
            const total = state.scenarios.length;
            const current = state.currentIndex + 1;
            document.getElementById('progressText').textContent = `Question ${current} of ${total}`;
            document.getElementById('progressFill').style.width = `${(current / total) * 100}%`;

            // Update block indicator
            const blocks = [1, 2, 3, 4, 5, 6];
            const currentBlock = state.scenarios[state.currentIndex]?.block || 1;
            const indicator = document.getElementById('blockIndicator');
            indicator.innerHTML = blocks.map(b => {
                const blockComplete = state.scenarios.filter(s => s.block === b).every(s => 
                    state.responses.find(r => r.scenarioId === s.id)
                );
                const isActive = b === currentBlock;
                return `<div class="block-dot ${isActive ? 'active' : ''} ${blockComplete ? 'complete' : ''}"></div>`;
            }).join('');
        }

        function startTimer() {
            state.timeRemaining = 8;
            updateTimerDisplay();
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('skipQuestionBtn').style.display = 'none';

            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                state.timeRemaining--;
                updateTimerDisplay();
                
                if (state.timeRemaining <= 0) {
                    clearInterval(state.timerInterval);
                    document.getElementById('nextBtn').style.display = 'block';
                    document.getElementById('skipQuestionBtn').style.display = 'block';
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timer = document.getElementById('timer');
            timer.textContent = state.timeRemaining;
            timer.className = 'timer';
            if (state.timeRemaining <= 3) timer.classList.add('critical');
            else if (state.timeRemaining <= 5) timer.classList.add('warning');
        }

        function renderScenario() {
            const scenario = state.scenarios[state.currentIndex];
            if (!scenario) {
                showResults();
                return;
            }

            document.getElementById('scenarioType').textContent = scenario.typeLabel;
            document.getElementById('scenarioQuestion').textContent = scenario.prompt;

            const optionA = scenario.options[0];
            const optionB = scenario.options[1];

            document.getElementById('choiceAText').textContent = optionA.label;
            document.getElementById('choiceBText').textContent = optionB.label;

            // Render consequences
            document.getElementById('choiceAConsequences').innerHTML = renderConsequences(optionA.consequences);
            document.getElementById('choiceBConsequences').innerHTML = renderConsequences(optionB.consequences);

            // Reset button states
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected-a', 'selected-b');
                btn.disabled = false;
            });

            // Check if already answered
            const existingResponse = state.responses.find(r => r.scenarioId === scenario.id);
            if (existingResponse) {
                const chosenBtn = document.querySelector(`[data-choice="${existingResponse.choice}"]`);
                if (chosenBtn) {
                    chosenBtn.classList.add(existingResponse.choice === 'A' ? 'selected-a' : 'selected-b');
                }
            }

            // Update navigation
            document.getElementById('backBtn').disabled = state.currentIndex === 0;
            
            updateProgress();
            startTimer();
        }

        function renderConsequences(consequences) {
            return consequences.map(c => {
                let icon, text;
                const profile = c.entity_type === 'human' ? humanProfiles[c.profile_id] : animalProfiles[c.profile_id];
                const label = c.count === 1 ? profile.label : (profile.labelPlural || profile.label + 's');
                
                if (c.outcome === 'survive') {
                    icon = '‚úì';
                    text = `${c.count.toLocaleString()} ${label.toLowerCase()} survive`;
                } else if (c.outcome === 'die') {
                    icon = '‚úó';
                    text = `${c.count.toLocaleString()} ${label.toLowerCase()} die`;
                } else if (c.outcome === 'improve_qol') {
                    icon = '‚Üë';
                    text = `Quality of life improved`;
                } else if (c.outcome === 'at_risk') {
                    icon = '?';
                    text = `${c.count.toLocaleString()} remain at risk`;
                } else {
                    icon = '‚àí';
                    text = `No change`;
                }

                if (c.probability && c.probability < 1) {
                    text += ` (${Math.round(c.probability * 100)}% chance)`;
                }

                return `<div class="consequence"><span class="consequence-icon">${icon}</span> ${text}</div>`;
            }).join('');
        }

        function recordResponse(choice) {
            clearInterval(state.timerInterval);
            
            const scenario = state.scenarios[state.currentIndex];
            const responseTime = 8 - state.timeRemaining;

            // Remove existing response for this scenario if going back
            state.responses = state.responses.filter(r => r.scenarioId !== scenario.id);

            state.responses.push({
                scenarioId: scenario.id,
                scenarioType: scenario.type,
                choice: choice,
                responseTime: responseTime,
                timestamp: new Date().toISOString(),
                metadata: scenario.metadata || {}
            });

            // Visual feedback
            const btn = document.querySelector(`[data-choice="${choice}"]`);
            btn.classList.add(choice === 'A' ? 'selected-a' : 'selected-b');
            document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);

            // Submit to backend
            submitResponse(scenario.id, choice, scenario);

            // Auto-advance
            setTimeout(() => {
                state.currentIndex++;
                if (state.currentIndex >= state.scenarios.length) {
                    showResults();
                } else {
                    renderScenario();
                }
            }, 300);
        }

        // ============================================
        // WEIGHT INFERENCE
        // ============================================
        function calculateWeights() {
            const results = {
                animalEquivalences: {},
                humanRelativeWeights: {},
                riskTolerance: {},
                qolTradeoffs: {},
                attentionCheckPassed: true
            };

            // Check attention check
            const attentionCheck = state.responses.find(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                return scenario?.isAttentionCheck;
            });
            if (attentionCheck) {
                const scenario = state.scenarios.find(s => s.id === attentionCheck.scenarioId);
                results.attentionCheckPassed = attentionCheck.choice === scenario.correctAnswer;
            }

            // Calculate animal equivalences (how many animals = 1 human)
            const animalThresholds = { mouse: [], dog: [], pig: [], monkey: [], chicken: [] };
            
            state.responses.forEach(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                if (scenario?.type === 'human_animal_certain' && scenario.metadata) {
                    const { animal, animalCount } = scenario.metadata;
                    if (animal && animalCount) {
                        // Did they save the human (killing animals)?
                        const savedHuman = r.choice === 'A' ? 
                            scenario.options[0].consequences.some(c => c.entity_type === 'human' && c.outcome === 'survive') :
                            scenario.options[1].consequences.some(c => c.entity_type === 'human' && c.outcome === 'survive');
                        
                        animalThresholds[animal].push({ count: animalCount, savedHuman });
                    }
                }
            });

            // Estimate equivalence ranges
            Object.keys(animalThresholds).forEach(animal => {
                const data = animalThresholds[animal];
                if (data.length === 0) {
                    results.animalEquivalences[animal] = { min: null, max: null, estimate: null };
                    return;
                }

                const savedHumanAt = data.filter(d => d.savedHuman).map(d => d.count);
                const savedAnimalsAt = data.filter(d => !d.savedHuman).map(d => d.count);

                const minAccepted = savedHumanAt.length > 0 ? Math.max(...savedHumanAt) : 0;
                const minRejected = savedAnimalsAt.length > 0 ? Math.min(...savedAnimalsAt) : Infinity;

                if (minAccepted === 0 && minRejected === Infinity) {
                    results.animalEquivalences[animal] = { min: null, max: null, estimate: null };
                } else if (minRejected === Infinity) {
                    results.animalEquivalences[animal] = { min: minAccepted, max: '‚àû', estimate: `>${minAccepted.toLocaleString()}` };
                } else if (minAccepted === 0) {
                    results.animalEquivalences[animal] = { min: 0, max: minRejected, estimate: `<${minRejected.toLocaleString()}` };
                } else {
                    const estimate = Math.round((minAccepted + minRejected) / 2);
                    results.animalEquivalences[animal] = { 
                        min: minAccepted, 
                        max: minRejected, 
                        estimate: `${minAccepted.toLocaleString()} - ${minRejected.toLocaleString()}`
                    };
                }
            });

            // Human relative weights
            const humanComparisons = {};
            state.responses.forEach(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                if (scenario?.type === 'human_baseline') {
                    const chosenOption = scenario.options.find(o => o.id === r.choice);
                    const savedProfile = chosenOption.consequences.find(c => c.outcome === 'survive')?.profile_id;
                    const notSavedOption = scenario.options.find(o => o.id !== r.choice);
                    const notSavedProfile = notSavedOption.consequences.find(c => c.outcome === 'survive')?.profile_id;
                    
                    if (savedProfile && notSavedProfile) {
                        if (!humanComparisons[savedProfile]) humanComparisons[savedProfile] = { wins: 0, total: 0 };
                        if (!humanComparisons[notSavedProfile]) humanComparisons[notSavedProfile] = { wins: 0, total: 0 };
                        humanComparisons[savedProfile].wins++;
                        humanComparisons[savedProfile].total++;
                        humanComparisons[notSavedProfile].total++;
                    }
                }
            });

            Object.keys(humanProfiles).forEach(profile => {
                if (humanComparisons[profile] && humanComparisons[profile].total > 0) {
                    const winRate = humanComparisons[profile].wins / humanComparisons[profile].total;
                    // Scale: adult_standard = 1.0, others relative
                    if (profile === 'adult_standard') {
                        results.humanRelativeWeights[profile] = 1.0;
                    } else {
                        results.humanRelativeWeights[profile] = 0.5 + winRate;
                    }
                }
            });

            // Normalize to adult_standard
            if (!results.humanRelativeWeights['adult_standard']) {
                results.humanRelativeWeights['adult_standard'] = 1.0;
            }

            // Risk tolerance
            const probabilisticResponses = state.responses.filter(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                return scenario?.type === 'testing_probabilistic';
            });

            const approvedProbs = [];
            const rejectedProbs = [];

            probabilisticResponses.forEach(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                const approved = r.choice === 'A';
                const prob = scenario.metadata?.probability;
                if (prob) {
                    if (approved) approvedProbs.push(prob);
                    else rejectedProbs.push(prob);
                }
            });

            if (approvedProbs.length > 0 || rejectedProbs.length > 0) {
                const minApproved = approvedProbs.length > 0 ? Math.min(...approvedProbs) : 1;
                const maxRejected = rejectedProbs.length > 0 ? Math.max(...rejectedProbs) : 0;
                
                results.riskTolerance = {
                    approvedAt: approvedProbs,
                    rejectedAt: rejectedProbs,
                    threshold: (minApproved + maxRejected) / 2,
                    tendency: approvedProbs.length > rejectedProbs.length ? 'accepting' : 'cautious'
                };
            }

            // QoL trade-offs
            const qolResponses = state.responses.filter(r => {
                const scenario = state.scenarios.find(s => s.id === r.scenarioId);
                return scenario?.type === 'qol_improvement';
            });

            const qolApproved = qolResponses.filter(r => r.choice === 'A').length;
            results.qolTradeoffs = {
                approved: qolApproved,
                total: qolResponses.length,
                tendency: qolApproved > qolResponses.length / 2 ? 'willing' : 'reluctant'
            };

            return results;
        }

        function showResults() {
            clearInterval(state.timerInterval);
            showScreen('resultsScreen');

            const weights = calculateWeights();

            // Render animal equivalences
            const animalContainer = document.getElementById('animalEquivalences');
            const animals = ['mouse', 'dog', 'pig', 'monkey'];
            
            animalContainer.innerHTML = animals.map(animal => {
                const data = weights.animalEquivalences[animal];
                const label = animalProfiles[animal].labelPlural;
                const estimate = data?.estimate || 'Insufficient data';
                
                return `
                    <div class="weight-row">
                        <span class="weight-label">${label}</span>
                        <div class="weight-bar-container">
                            <span class="weight-value-outside">${estimate}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Animal insight
            const animalInsight = document.getElementById('animalInsight');
            const mouseData = weights.animalEquivalences.mouse;
            if (mouseData?.estimate) {
                animalInsight.innerHTML = `<p>Based on your answers, you treated 1 adult human life as roughly equivalent to <strong>${mouseData.estimate} mice</strong>.</p>`;
            } else {
                animalInsight.innerHTML = `<p>Insufficient data to estimate precise equivalences.</p>`;
            }

            // Human weights
            const humanContainer = document.getElementById('humanWeights');
            const profileOrder = ['child', 'pregnant', 'adult_standard', 'elderly', 'adult_disabled'];
            
            humanContainer.innerHTML = profileOrder.map(profile => {
                const weight = weights.humanRelativeWeights[profile] || 1.0;
                const width = Math.min(weight * 50, 100);
                const label = humanProfiles[profile].label;
                
                return `
                    <div class="weight-row">
                        <span class="weight-label">${label}</span>
                        <div class="weight-bar-container">
                            <div class="weight-bar" style="width: ${width}%">
                                <span class="weight-value">${weight.toFixed(2)}√ó</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Risk insight
            const riskInsight = document.getElementById('riskInsight');
            if (weights.riskTolerance.threshold) {
                const threshold = Math.round(weights.riskTolerance.threshold * 100);
                riskInsight.innerHTML = `
                    <p>You were generally <strong>${weights.riskTolerance.tendency}</strong> of animal testing for medical benefit.</p>
                    <p>Your approximate probability threshold for approving experiments: around <strong>${threshold}%</strong> chance of success.</p>
                `;
            } else {
                riskInsight.innerHTML = `<p>Insufficient data to determine risk tolerance patterns.</p>`;
            }

            // QoL insight
            const qolInsight = document.getElementById('qolInsight');
            if (weights.qolTradeoffs.total > 0) {
                qolInsight.innerHTML = `
                    <p>You were <strong>${weights.qolTradeoffs.tendency}</strong> to approve animal testing for quality-of-life improvements (as opposed to life-saving treatments).</p>
                    <p>Approved ${weights.qolTradeoffs.approved} of ${weights.qolTradeoffs.total} quality-of-life scenarios.</p>
                `;
            } else {
                qolInsight.innerHTML = `<p>No quality-of-life scenarios were answered.</p>`;
            }

            // Submit final session
            submitFullSession();
        }

        // ============================================
        // API SUBMISSION
        // ============================================
        const SUPABASE_URL = 'https://nxmdvyngyrkqykbsligr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_OVcVdS_I6F0ODbP6b1IzrQ_xe9vx6fJ';

        async function submitResponse(scenarioId, choice, scenario) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/responses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        session_id: state.sessionId,
                        scenario_id: scenarioId,
                        choice: choice,
                        response_time: 8 - state.timeRemaining,
                        scenario: {
                            type: scenario.type,
                            prompt: scenario.prompt,
                            options: scenario.options,
                            metadata: scenario.metadata
                        },
                        user_agent: navigator.userAgent
                    })
                });
            } catch (e) {
                console.log('Submission failed, data saved locally');
            }
        }

        async function submitFullSession() {
            try {
                const weights = calculateWeights();
                await fetch(`${SUPABASE_URL}/rest/v1/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        session_id: state.sessionId,
                        session_start: state.sessionStart,
                        completed_at: new Date().toISOString(),
                        demographics: state.demographics,
                        total_responses: state.responses.length,
                        calculated_weights: weights,
                        responses: state.responses,
                        user_agent: navigator.userAgent
                    })
                });
            } catch (e) {
                console.log('Session submission failed');
            }
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================
        document.getElementById('consentCheck').addEventListener('change', function() {
            document.getElementById('startBtn').disabled = !this.checked;
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            showScreen('demographicsScreen');
        });

        document.getElementById('skipDemoBtn').addEventListener('click', () => {
            showScreen('tutorialScreen');
        });

        document.getElementById('continueDemoBtn').addEventListener('click', () => {
            state.demographics = {
                ageGroup: document.getElementById('ageGroup').value,
                country: document.getElementById('country').value,
                diet: document.getElementById('diet').value,
                scienceInvolvement: document.getElementById('scienceInvolvement').value
            };
            showScreen('tutorialScreen');
        });

        document.getElementById('startQuestionsBtn').addEventListener('click', () => {
            state.scenarios = generateScenarios();
            showScreen('questionsScreen');
            renderScenario();
        });

        document.querySelectorAll('.choice-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!this.disabled) {
                    recordResponse(this.dataset.choice);
                }
            });
        });

        document.getElementById('backBtn').addEventListener('click', () => {
            if (state.currentIndex > 0) {
                clearInterval(state.timerInterval);
                state.currentIndex--;
                renderScenario();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            // Skip without answering
            state.currentIndex++;
            if (state.currentIndex >= state.scenarios.length) {
                showResults();
            } else {
                renderScenario();
            }
        });

        document.getElementById('skipQuestionBtn').addEventListener('click', () => {
            state.currentIndex++;
            if (state.currentIndex >= state.scenarios.length) {
                showResults();
            } else {
                renderScenario();
            }
        });

        document.getElementById('exportResultsBtn').addEventListener('click', () => {
            const exportData = {
                sessionId: state.sessionId,
                sessionStart: state.sessionStart,
                demographics: state.demographics,
                responses: state.responses,
                calculatedWeights: calculateWeights()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `moral-weights-${state.sessionId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('restartBtn').addEventListener('click', () => {
            if (confirm('Start over with new questions?')) {
                state = {
                    sessionId: generateSessionId(),
                    sessionStart: new Date().toISOString(),
                    demographics: {},
                    scenarios: [],
                    currentIndex: 0,
                    responses: [],
                    timerInterval: null,
                    timeRemaining: 8
                };
                document.getElementById('consentCheck').checked = false;
                document.getElementById('startBtn').disabled = true;
                showScreen('welcomeScreen');
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('questionsScreen').classList.contains('active')) {
                if (e.key === '1' || e.key === 'a' || e.key === 'A') {
                    const btn = document.querySelector('[data-choice="A"]');
                    if (btn && !btn.disabled) btn.click();
                } else if (e.key === '2' || e.key === 'b' || e.key === 'B') {
                    const btn = document.querySelector('[data-choice="B"]');
                    if (btn && !btn.disabled) btn.click();
                } else if (e.key === 'Backspace' || e.key === 'ArrowLeft') {
                    document.getElementById('backBtn').click();
                }
            }
        });
    </script>
</body>
</html>